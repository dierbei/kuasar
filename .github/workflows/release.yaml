name: release

concurrency:
  group: release-${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

on:
  push:
    tags:
      - '**/v[0-9]+.[0-9]+.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        directories: ["wasm"]  # 您可以添加其他目录
      include:
        - directories: "wasm"
          # features: "--features=wasmedge"
          command: bin/wasm-sandboxer
          wasmEdge: "0.11.2"
        # - directories: "wasm"
        #   features: "--features=wasmtime"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v3
      - run: rustup toolchain install nightly --component rustfmt
      - name: Install Protoc
        uses: arduino/setup-protoc@v1.1.2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install WasmEdge
        if: ${{ matrix.wasmEdge }}
        run: curl -sSf https://raw.githubusercontent.com/WasmEdge/WasmEdge/master/utils/install.sh | bash -s -- -v ${{ matrix.wasmEdge }} >> /dev/null
      - name: Build
        # working-directory: ${{ matrix.directories }}
        run: make ${{ matrix.command }} && ls bin
      # - name: Nightly fmt
      #   working-directory: ${{ matrix.directories }}
      #   run: cargo +nightly fmt --all -- --check
      # - name: Clippy
      #   working-directory: ${{ matrix.directories }}
      #   run: cargo clippy ${{ matrix.features }} -- -D warnings
      # - name: Deny
      #   working-directory: ${{ matrix.directories }}
      #   run: cargo install cargo-deny && cargo deny -L warn ${{ matrix.features }} check